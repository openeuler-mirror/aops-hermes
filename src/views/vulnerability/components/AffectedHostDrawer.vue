<script lang="ts" setup>
import { ref } from 'vue'
import type { Rpm } from '@/api'
import { api } from '@/api'

const props = defineProps<{
  rpmInfo: Rpm
  cveId: string
  fixed: boolean
}>()
const isDrawerVisible = ref(false)

const tableColumns = [
  {
    dataIndex: 'index',
    title: '序号',
  },
  {
    dataIndex: 'host_name',
    title: '主机名',
  },
  {
    dataIndex: 'host_ip',
    title: 'IP地址',
  },
]

const tableData = ref<
  {
    host_ip: string
    host_name: string
  }[]
>([])

const isTableLoading = ref(false)

async function handleOpen() {
  isTableLoading.value = true
  const { cveId, rpmInfo, fixed } = props
  const [, res] = await api.getHostsWithPackage({
    cve_id: cveId,
    fixed,
    available_rpm: rpmInfo.available_rpm,
    installed_rpm: rpmInfo.installed_rpm,
    direction: 'asc',
  })
  if (res) {
    tableData.value = res.result.map((item, index) => ({
      index: index + 1,
      host_ip: item.host_ip,
      host_name: item.host_name,
    }))
  }
  isTableLoading.value = false
}
</script>

<template>
  <div class="affected-hosts">
    <div @click="isDrawerVisible = true">
      <slot name="trigger" />
    </div>
    <a-drawer
      v-model:open="isDrawerVisible"
      :width="600"
      title="RPM-主机列表"
      placement="right"
      :closable="false"
      destroy-on-close
      @after-open-change="handleOpen"
    >
      <a-table
        :columns="tableColumns"
        :data-source="tableData"
        :pagination="false"
        :loading="isTableLoading"
        bordered
      />
    </a-drawer>
  </div>
</template>
