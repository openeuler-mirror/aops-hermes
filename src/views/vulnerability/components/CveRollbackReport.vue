<script setup lang="ts">
import { computed } from 'vue';
import dayjs from 'dayjs'
import { CheckCircleTwoTone, CloseCircleTwoTone } from '@ant-design/icons-vue'
import { useI18n } from 'vue-i18n'
import type { CveRollbackTaskReport } from '@/api'

defineProps<{
  taskReport: CveRollbackTaskReport[]
}>()

const { t } = useI18n()

const CveStatus = computed(() => ({
  succeed: t('vul.task.taskStatus.rollbacklSucceed'),
  fail: t('vul.task.taskStatus.rollbackFailed'),
  unknown: t('vul.task.taskStatus.unknown'),
}))

enum CveBadgeStatus {
  succeed = 'success',
  fail = 'error',
  unknown = 'default',
}

function logFormat(str: string) {
  if (str && str !== '')
    return str.replace(/\n/g, '<br>')
}
</script>

<template>
  <a-descriptions :column="{ sm: 1 }">
    <a-descriptions-item v-if="taskReport[0]" :label="$t('vul.task.taskType')">
      {{ taskReport[0].task_type }}
    </a-descriptions-item>
    <a-descriptions-item v-if="taskReport[0]" :label="$t('vul.task.lastExcute')">
      {{ dayjs(taskReport[0].latest_execute_time * 1000).format('YYYY-MM-DD HH:mm:ss') }}
    </a-descriptions-item>
  </a-descriptions>
  <p>{{ $t('vul.task.excuteResult') }}</p>
  <a-collapse default-active-key="0">
    <a-collapse-panel
      v-for="(resultItem, index) in taskReport"
      :key="index"
      :header="`${t('vul.cves.hosts')}ï¼š ${resultItem.host_name}`"
    >
      <template #extra>
        <a-badge :status="CveBadgeStatus[resultItem.task_result.result]" />
      </template>
      <a-descriptions :column="{ sm: 1 }">
        <a-descriptions-item :label="$t('vul.task.hostIp')">
          {{ resultItem.host_ip }}
        </a-descriptions-item>
        <a-descriptions-item :label="$t('vul.task.status')">
          {{ CveStatus[resultItem.task_result.result] }}
        </a-descriptions-item>
      </a-descriptions>
      <span>{{ $t('vul.task.checkItem') }} </span>
      <span v-if="resultItem.task_result.check_items.length === 0">  {{ t('common.none') }}</span>
      <a-descriptions>
        <a-descriptions-item
          v-for="item in resultItem.task_result.check_items"
          :key="item.item"
          :label="item.item"
        >
          <CheckCircleTwoTone v-if="item.result" class="icon" two-tone-color="#52c41a" />
          <CloseCircleTwoTone v-else class="icon" two-tone-color="#ff0000" />
        </a-descriptions-item>
      </a-descriptions>
      <h4 style="margin-top: 15px">
        {{ $t('vul.rpmFixStatus') }}
      </h4>
      <a-collapse default-active-key="0">
        <a-collapse-panel
          v-for="(rpm, rpmIndex) in resultItem.task_result.rpms"
          :key="rpmIndex"
          :header="`CVE: ${rpm.cves}`"
        >
          <template #extra>
            <a-badge :status="CveBadgeStatus[resultItem.task_result.result]" />
          </template>
          <h4>{{ t('vul.task.installedRpm') }}: {{ rpm.installed_rpm }}</h4>
          <h4>{{ t('vul.task.targetRpm') }}: {{ rpm.target_rpm }}</h4>
        </a-collapse-panel>
      </a-collapse>
      <h4>Log:</h4>
      <div class="log-container" v-html="logFormat(resultItem.task_result.log)" />
    </a-collapse-panel>
  </a-collapse>
</template>

<style scoped>
.log-container {
  border: 1px solid #eee;
  padding: 10px 5px;
}
</style>
