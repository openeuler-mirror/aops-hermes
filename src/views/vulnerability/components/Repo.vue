<script setup lang="ts">
import { ClusterOutlined, DownOutlined, QuestionCircleOutlined } from '@ant-design/icons-vue'
import { computed, reactive, ref } from 'vue'
import { message } from 'ant-design-vue'
import { storeToRefs } from 'pinia'
import CreateRepoModal from './CreateRepoModal.vue'
import CheckRepoModal from './CheckRepoModal.vue'
import { api } from '@/api'
import type { Repo } from '@/api'
import { useRepoStore } from '@/store'

const { repos } = storeToRefs(useRepoStore())
const { queryRepos } = useRepoStore()

const isCheckModalVisible = ref(false)
const isCreateModalVisible = ref(false)

const pagination = reactive({
  current: 1,
  pageSize: 6,
})

const searchKey = ref('')
const filterKey = ref('')

const filteredRepos = computed(() => {
  const { current, pageSize } = pagination
  let list = repos.value
  if (filterKey.value)
    list = repos.value.filter(item => item.repo_name.includes(filterKey.value))

  return list.slice((current - 1) * pageSize, current * pageSize)
})

const totalRepos = computed(() => repos.value.length)

const selectedRepo = ref<Repo>()

async function handleDeleteRepo(repo: Repo) {
  const { cluster_id, repo_id } = repo
  const params = {}
  params[cluster_id] = {
    repo_id_list: [repo_id],
  }
  const [_] = await api.deleteRepo(params)
  if (!_) {
    pagination.current = 1
    pagination.pageSize = 6
    queryRepos()
    message.success('删除成功')
  }
}

function handleSearch(key: string) {
  pagination.current = 1
  pagination.pageSize = 6
  filterKey.value = key
}
</script>

<template>
  <a-row type="flex" justify="space-between">
    <a-col>
      <a-input-search v-model:value="searchKey" placeholder="按集群搜索" @search="handleSearch" />
    </a-col>
    <a-col>
      <a-space>
        <a-button type="primary" @click="isCreateModalVisible = true">
          新增REPO
        </a-button>
      </a-space>
    </a-col>
  </a-row>
  <a-list
    :data-source="filteredRepos"
    :grid="{ gutter: 24, xxl: 3, xl: 3, lg: 4, md: 2, sm: 1, xs: 1 }"
    style="margin-top: 10px"
  >
    <template #renderItem="{ item }">
      <a-list-item style="padding: 0">
        <a-card
          :body-style="{ padding: 0 }"
          class="repo-card"
          @click="
            isCheckModalVisible = true;
            selectedRepo = item;
          "
        >
          <div class="repo-card-title">
            <h2>{{ item.repo_name }}</h2>
            <h4><ClusterOutlined style="color: #1677ff" /> {{ item.cluster_name }}</h4>
          </div>
          <a-row type="flex" justify="end" align="middle" class="repo-card-operate" @click.stop>
            <a-col>
              <a-space>
                <a-popconfirm
                  title="你确定删除这行配置吗?"
                  ok-text="确认"
                  cancel-text="取消"
                  @confirm="handleDeleteRepo(item)"
                >
                  <template #icon>
                    <QuestionCircleOutlined style="color: red" />
                  </template>
                  <a>删除</a>
                </a-popconfirm>
                <a-divider type="vertical" />
                <a-dropdown>
                  <a>
                    更多
                    <DownOutlined />
                  </a>
                  <template #overlay>
                    <a-menu>
                      <a-menu-item disabled>
                        <a>导出</a>
                      </a-menu-item>
                      <a-menu-item disabled>
                        <a>编辑</a>
                      </a-menu-item>
                    </a-menu>
                  </template>
                </a-dropdown>
              </a-space>
            </a-col>
          </a-row>
        </a-card>
      </a-list-item>
    </template>
    <CheckRepoModal v-model:visible="isCheckModalVisible" :repo-info="selectedRepo!" />
  </a-list>
  <CreateRepoModal v-model:visible="isCreateModalVisible" />
  <a-row v-if="filteredRepos.length" type="flex" justify="end">
    <a-col>
      <a-pagination
        v-model:current="pagination.current"
        v-model:page-size="pagination.pageSize"
        :show-total="(total:number) => `共 ${total} 个`"
        :total="totalRepos"
      />
    </a-col>
  </a-row>
</template>

<style lang="less" scoped>
.repo-card {
  border-radius: 4px;
  height: 140px;
  border-radius: 4px;
  height: 140px;
  cursor: pointer;
  &:hover {
    box-shadow: 0px 0px 10px rgba(87, 113, 219, 0.45);
  }
  &-title {
    color: #000000;
    height: 100px;
    border-bottom: 1px solid #eee;
    padding: 12px;
  }
  &-operate {
    height: 40px;
    padding: 0 12px;
    font-size: 8px;
  }
}
</style>
