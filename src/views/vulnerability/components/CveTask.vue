<script setup lang="ts">
import type { TableColumnType } from 'ant-design-vue'
import { message } from 'ant-design-vue'
import { CheckOutlined, CloseOutlined, QuestionCircleOutlined } from '@ant-design/icons-vue'
import { computed, onBeforeMount, reactive, ref } from 'vue'
import { api } from '@/api'
import type { Rpm, generateCveFixTaskParams, generateCveHotPatchTaskParams } from '@/api'
import { useClusterStore } from '@/store'

const props = withDefaults(
  defineProps<{
    taskType: string
    cveList: Array<CveItemWithRpms>
    hostListInCve?: Array<HostsInCve>
    isFixed: boolean
  }>(),
  {
    taskType: 'cve fix',
    cveList: () => [],
    isFixed: false,
  },
)
const emit = defineEmits<{
  (e: 'cancel')
  (e: 'close')
  (e: 'success', type: 'success' | 'warn', content: string)
}>()
enum TaskTypeEnum {
  'cve fix' = 'cve修复',
  'hotpath remove' = '热补丁移除',
}
enum TaskNameEnum {
  'cve fix' = 'CVE修复任务',
  'hotpath remove' = '热补丁移除任务',
}
export interface HostInfoInCve {
  host_id: string
  host_name: string
  host_ip: string
  cluster_id: string
  cluster_name: string
}
export interface HostsInCve {
  cve_id: string
  hosts: HostInfoInCve[]
}

export interface CveItemWithRpms {
  cve_id: string
  rpms?: Rpm[]
}

const { clusters } = useClusterStore()

const cves = ref<Array<CveItemWithRpms>>(props.cveList)
const defaultTaskDesc = computed(() => {
  let desc: string
  if (props.isFixed) {
    desc = `移除以下${cves.value.length} 个CVE:${cves.value.map(i => i.cve_id).join('、')}`
    desc = desc.length > 28 ? `${desc.slice(0, 25)}...的热补丁` : `${desc}的热补丁`
  }
  else {
    desc = `修复以下${cves.value.length} 个CVE:${cves.value.map(i => i.cve_id).join('、')}`
    desc = desc.length > 28 ? `${desc.slice(0, 25)}...` : desc
  }
  return desc
})

interface Form {
  accepted: boolean
  check_items: string[]
  description: string
  takeover: boolean
  task_name: string
}
const formRef = ref()
const form = reactive<Form>({
  accepted: false,
  check_items: [],
  description: '',
  takeover: false,
  task_name: TaskNameEnum[props.taskType],
})

const tableState = reactive<{
  tableLoading: boolean
  expandedRowKeys: string[]
  isGenerating: boolean
  isExectuing: boolean
}>({
  tableLoading: false,
  expandedRowKeys: [],
  isGenerating: false,
  isExectuing: false,
})
const expandRowSlection = reactive<{
  selectedRowKeys: string[]
  onSelect: (record: any, selected: boolean) => void
  onSelectAll: (selected: boolean, selectedRows: any[]) => void
}>({
      selectedRowKeys: [],
      onSelect: (record, selected: boolean) => {
        if (selected) {
          expandRowSlection.selectedRowKeys.push(record.host_id)
        }
        else {
          expandRowSlection.selectedRowKeys = expandRowSlection.selectedRowKeys.filter(
            i => i !== record.host_id,
          )
        }
      },
      onSelectAll: (_selected: boolean, selectedRows: any[]) => {
        expandRowSlection.selectedRowKeys = selectedRows.map(item => item.host_id)
      },
    })

const hostsInCve = ref<HostsInCve[]>()
/**
 * query host list in cves
 */
async function queryHostsInCve(): Promise<void> {
  tableState.tableLoading = true
  /**
   * select all host
   * @param list
   */
  const selectAllHost = (list: HostsInCve[]) => {
    list.forEach((item) => {
      item.hosts.forEach(({ host_id }) => {
        expandRowSlection.selectedRowKeys.push(host_id)
      })
    })
  }

  if (props.hostListInCve && props.hostListInCve.length > 0) {
    hostsInCve.value = props.hostListInCve
    selectAllHost(hostsInCve.value)
    form.description = defaultTaskDesc.value
    tableState.tableLoading = false
    return
  }
  // let cveList = props.cveList;

  /**
   * query cve list
   */
  const queryCveList = async () => {
    const [, res] = await api.getCves({
      filter: {
        affected: true,
        fixed: props.isFixed,
        severity: [],
      },
    })
    if (res)
      cves.value = res.result
  }

  if (cves.value.length === 0)
    await queryCveList()

  form.description = defaultTaskDesc.value
  const [_, res] = await api.getHostsInCves({
    cve_list: cves.value.map(i => ({
      cve_id: i.cve_id,
      rpms: i.rpms
        ? i.rpms.map(({ available_rpm, installed_rpm, support_way }) => ({
          available_rpm,
          installed_rpm,
          fix_way: support_way,
        }))
        : [],
    })),
    fixed: props.isFixed,
  })
  if (res) {
    hostsInCve.value = Object.keys(res).map((i) => {
      return {
        cve_id: i,
        hosts: res[i].hosts,
      }
    })
    selectAllHost(hostsInCve.value)
  }
  tableState.tableLoading = false
}

const tableColunms = computed<TableColumnType[]>(() => {
  const columns = [
    {
      dataIndex: 'cve_id',
      title: 'CVE_ID',
    },
    {
      dataIndex: 'hosts',
      title: '主机',
    },
  ]

  return columns
})

const expandTableColunms = computed<TableColumnType[]>(() => {
  const columns = [
    {
      dataIndex: 'host_name',
      title: '主机',
    },
    {
      dataIndex: 'host_ip',
      title: 'IP地址',
    },
    {
      dataIndex: 'cluster_name',
      title: '集群',
    },
  ]
  if (props.isFixed) {
    columns.push({
      dataIndex: 'hotpatch',
      title: '热补丁修复',
    })
  }
  return columns
})

/**
 * create new cve task
 */
async function CreateCveTask(execute: boolean = false) {
  /**
   * parse cluster distribute params which cve is unfixed
   */
  const parseUnFixedParams = () => {
    const params: generateCveFixTaskParams = {}
    hostsInCve.value!.forEach(({ hosts, cve_id }) => {
      hosts.forEach(({ host_id, cluster_id }) => {
        if (expandRowSlection.selectedRowKeys.includes(host_id)) {
          const cve = cves.value.find(cve => cve.cve_id === cve_id)!

          if (!params[cluster_id]) {
            params[cluster_id] = {
              task_name: form.task_name,
              accepted: form.accepted,
              takeover: form.takeover,
              description: form.description,
              check_items: [],
              info: [
                {
                  cve_id,
                  host_info: [{ host_id }],
                  rpms: cve.rpms
                    ? cve.rpms.map(({ available_rpm, installed_rpm, support_way }) => ({
                      available_rpm,
                      installed_rpm,
                      fix_way: support_way,
                    }))
                    : [],
                },
              ],
            }
          }
          else {
            const cves = params[cluster_id].info.map(i => i.cve_id)
            if (cves.includes(cve_id)) {
              const ind = params[cluster_id].info.findIndex(i => i.cve_id === cve_id)
              params[cluster_id].info[ind].host_info.push({ host_id })
            }
            else {
              params[cluster_id].info.push({
                cve_id,
                host_info: [{ host_id }],
                rpms: cve.rpms
                  ? cve.rpms.map(({ available_rpm, installed_rpm, support_way }) => ({
                    available_rpm,
                    installed_rpm,
                    fix_way: support_way,
                  }))
                  : [],
              })
            }
          }
        }
      })
    })
    return params
  }
  /**
   * parse cluster distribute params which cve is fixed
   */
  const parseFixedParams = () => {
    const params: generateCveHotPatchTaskParams = {}
    hostsInCve.value!.forEach(({ hosts, cve_id }) => {
      hosts.forEach(({ host_id, cluster_id }) => {
        if (expandRowSlection.selectedRowKeys.includes(host_id)) {
          if (!params[cluster_id]) {
            params[cluster_id] = {
              task_name: form.task_name,
              description: form.description,
              info: [
                {
                  host_id,
                  cves: [{ cve_id }],
                },
              ],
            }
          }
          else {
            const hostList = params[cluster_id].info.map(i => i.host_id)
            if (!hostList.includes(host_id)) {
              params[cluster_id].info.push({
                host_id,
                cves: [{ cve_id }],
              })
            }
            else {
              const ind = params[cluster_id].info.findIndex(i => i.host_id === host_id)
              params[cluster_id][ind].cves.push({ cve_id })
            }
          }
        }
      })
    })
    return params
  }
  /**
   * parse execute param for executing task
   */
  const parseExecuteParams = (
    origin: Record<string, { data: { fix_way?: string, task_id: string }[], label: string }>,
  ) => {
    const params: Record<string, { task_id: string }> = {}
    Object.keys(origin).forEach((key) => {
      const task = origin[key].data.filter(
        item => !item.fix_way || item.fix_way === 'coldpatch',
      )[0]
      params[key] = {
        task_id: task.task_id,
      }
    })
    return params
  }
  try {
    execute ? (tableState.isExectuing = true) : (tableState.isGenerating = true)
    await formRef.value.validate()
    if (expandRowSlection.selectedRowKeys.length === 0)
      return message.info(`请至少选择一个cve下的一台主机进行${TaskTypeEnum[props.taskType]}!`)
    let generateRes: Record<
      string,
      { data: { fix_way?: string, task_id: string }[], label: string }
    > | null = null
    if (!props.isFixed) {
      const params: generateCveFixTaskParams = parseUnFixedParams()
      const [, res] = await api.generateCveFixTask(params)

      res && (generateRes = res)
    }
    else {
      const params: generateCveHotPatchTaskParams = parseFixedParams()
      const [, res] = await api.generateCveHotPatchTask(params)

      res && (generateRes = res)
    }

    const failList: string[] = []
    let generateMsg = `${TaskNameEnum[props.taskType]}创建成功`

    if (!generateRes)
      return
    if (execute) {
      const params = parseExecuteParams(generateRes)
      const [_] = await api.executeTask(params)
      if (!_)
        message.success('执行成功')
    }
    else {
      Object.keys(generateRes).forEach((key) => {
        const label = generateRes[key].label
        if (label !== 'Succeed') {
          const clusterName = clusters.find(item => item.cluster_id === key)!.cluster_name
          failList.push(clusterName)
        }
      })

      if (failList.length > 0)
        message.warning('部分集群创建任务失败，请前往任务列表查看！')
      generateMsg = `${failList.join(',')}集群${TaskNameEnum[props.taskType]}创建失败`
    }
    emit('success', failList.length === 0 ? 'success' : 'warn', generateMsg)
  }
  catch {
  }
  finally {
    tableState.isGenerating = false
    tableState.isExectuing = false
  }
}

onBeforeMount(() => {
  queryHostsInCve()
})
</script>

<template>
  <div class="cve-task">
    <a-form ref="formRef" :model="form" :label-col="{ span: 5 }" :wrapper-col="{ span: 18 }">
      <a-form-item label="任务类型">
        <span>{{ TaskTypeEnum[taskType] }}</span>
      </a-form-item>

      <a-form-item
        name="task_name"
        label="任务名称"
        :rules="[{ required: true, message: '请输入任务名称' }]"
      >
        <a-input
          v-model:value="form.task_name"
          placeholder="请输入任务名称"
          :default-value="TaskNameEnum[taskType]"
        />
      </a-form-item>

      <a-form-item
        name="description"
        label="任务描述"
        :rules="[{ required: true, message: '请输入任务描述' }]"
      >
        <a-textarea v-model:value="form.description" :rows="4" placeholder="请输入任务描述" maxlength="50" />
      </a-form-item>

      <a-form-item v-if="taskType === 'cve fix'" name="accepted">
        <template #label>
          <a-space>
            <span>是否accept</span>
            <a-popover>
              <template #content>
                <p>如使用热补丁修复，accept后会在重启时自动应用热补丁，不勾选则重启时失效</p>
              </template>
              <QuestionCircleOutlined />
            </a-popover>
          </a-space>
        </template>
        <a-switch v-model:checked="form.accepted">
          <template #checkedChildren>
            <CheckOutlined />
          </template>
          <template #unCheckedChildren>
            <CloseOutlined />
          </template>
        </a-switch>
      </a-form-item>

      <a-form-item v-if="taskType === 'cve fix'" name="takeover">
        <template #label>
          <a-space>
            <span>冷补丁收编</span>
            <a-popover>
              <template #content>
                <p>仅针对内核：应用热补丁后会同步安装最新冷补丁。 若收编失败会自动accept热补丁</p>
              </template>
              <QuestionCircleOutlined />
            </a-popover>
          </a-space>
        </template>
        <a-switch v-model:checked="form.takeover">
          <template #checkedChildren>
            <CheckOutlined />
          </template>
          <template #unCheckedChildren>
            <CloseOutlined />
          </template>
        </a-switch>
      </a-form-item>
    </a-form>

    <a-table
      v-model:expandedRowKeys="tableState.expandedRowKeys"
      row-key="cve_id"
      :columns="tableColunms"
      :data-source="hostsInCve"
      :pagination="false"
      :loading="tableState.tableLoading"
    >
      <template #headerCell="{ title, column }">
        <template v-if="column.dataIndex === 'hosts'">
          <a-space>
            <span>{{ title }}</span>
            <a-tooltip placement="topRight">
              <template #title>
                <span>cve选中的修复方式对应的主机数量</span>
              </template>
              <QuestionCircleOutlined />
            </a-tooltip>
          </a-space>
        </template>
      </template>
      <template #bodyCell="{ record, column }">
        <template v-if="column.dataIndex === 'hosts'">
          {{ record.hosts.length }}
        </template>
      </template>
      <template #expandedRowRender="{ record }">
        <a-table
          row-key="host_id"
          :columns="expandTableColunms"
          :data-source="record.hosts"
          :pagination="false"
          :row-selection="expandRowSlection"
        >
          <template #bodyCell="{ record: expandRecord, column }">
            <template v-if="column.dataIndex === 'hotpatch'">
              {{ expandRecord.hotpatch ? '是' : '否' }}
            </template>
          </template>
        </a-table>
      </template>
    </a-table>

    <a-row class="button-group" type="flex" justify="end">
      <a-space>
        <a-button @click="$emit('cancel')">
          取消
        </a-button>
        <a-button
          type="primary"
          :disabled="tableState.isExectuing"
          :loading="tableState.isGenerating"
          @click="CreateCveTask(false)"
        >
          创建
        </a-button>
        <a-button
          type="primary"
          :disabled="tableState.isGenerating"
          :loading="tableState.isExectuing"
          @click="CreateCveTask(true)"
        >
          立即执行
        </a-button>
      </a-space>
    </a-row>
  </div>
</template>

<style scoped>
.cve-task {
  padding-bottom: 40px;
}
.button-group {
  position: absolute;
  bottom: 0;
  width: 94%;
  padding: 10px 0;
  background-color: #fff;
}
</style>
