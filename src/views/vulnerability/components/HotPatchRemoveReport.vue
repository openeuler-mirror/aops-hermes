<script setup lang="ts">
import dayjs from 'dayjs'
import { CheckCircleTwoTone, CloseCircleTwoTone } from '@ant-design/icons-vue'
import type { HotPatchRemoveTaskReport } from '@/api'

defineProps<{
  taskReport: HotPatchRemoveTaskReport[]
}>()

enum CveStatus {
  succeed = '移除成功',
  fail = '移除失败',
  unknown = '未知',
}

enum CveBadgeStatus {
  succeed = 'success',
  fail = 'error',
  unknown = 'default',
}

function logFormat(str: string) {
  if (str && str !== '')
    return str.replace(/\n/g, '<br>')
}
</script>

<template>
  <a-descriptions :column="{ sm: 1 }">
    <a-descriptions-item v-if="taskReport[0]" label="任务类型">
      {{ taskReport[0].task_type }}
    </a-descriptions-item>
    <a-descriptions-item v-if="taskReport[0]" label="上次执行时间">
      {{ dayjs(taskReport[0].latest_execute_time * 1000).format('YYYY-MM-DD HH:mm:ss') }}
    </a-descriptions-item>
  </a-descriptions>
  <p>任务结果:</p>
  <a-collapse default-active-key="0">
    <a-collapse-panel
      v-for="(resultItem, index) in taskReport"
      :key="index"
      :header="`主机： ${resultItem.host_name}`"
    >
      <template #extra>
        <a-badge :status="CveBadgeStatus[resultItem.status]" />
      </template>
      <a-descriptions :column="{ sm: 1 }">
        <a-descriptions-item label="主机地址">
          {{ resultItem.host_ip }}
        </a-descriptions-item>
        <a-descriptions-item label="状态">
          {{ CveStatus[resultItem.status] }}
        </a-descriptions-item>
      </a-descriptions>
      <span>检查项: </span>
      <span
        v-if="
          !resultItem.task_result.check_items || resultItem.task_result.check_items?.length === 0
        "
      >
        无
      </span>
      <a-descriptions>
        <a-descriptions-item
          v-for="item in resultItem.task_result.check_items"
          :key="item.item"
          :label="item.item"
        >
          <CheckCircleTwoTone v-if="item.result" class="icon" two-tone-color="#52c41a" />
          <CloseCircleTwoTone v-else class="icon" two-tone-color="#ff0000" />
        </a-descriptions-item>
      </a-descriptions>
      <h4 style="margin-top: 15px">
        热补丁移除情况:
      </h4>
      <a-collapse default-active-key="0">
        <a-collapse-panel
          v-for="(cve, cveIndex) in resultItem.task_result.cves"
          :key="cveIndex"
          :header="`CVE: ${cve.cve_id}`"
        >
          <template #extra>
            <a-badge :status="CveBadgeStatus[cve.result]" />
          </template>
          <p>结果： {{ CveStatus[cve.result] }}</p>
          <h4>Log:</h4>
          <div class="log-container" v-html="logFormat(cve.log)" />
        </a-collapse-panel>
      </a-collapse>
    </a-collapse-panel>
  </a-collapse>
</template>

<style scoped>
.log-container {
  border: 1px solid #eee;
  padding: 10px 5px;
}
</style>
