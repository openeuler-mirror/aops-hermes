<script setup lang="ts">
import dayjs from 'dayjs'
import { CheckCircleTwoTone, CloseCircleTwoTone } from '@ant-design/icons-vue'
import { useI18n } from 'vue-i18n'
import type { RepoTaskReport } from '@/api'

defineProps<{
  taskReport: RepoTaskReport[]
}>()

const { t } = useI18n()

const RepoSetStatus = {
  succeed: t('vul.task.taskStatus.repoSucceed'),
  fail: t('vul.task.taskStatus.repoFailed'),
  unknown: t('vul.task.taskStatus.unknown'),
}

function logFormat(str: string) {
  if (str && str !== '')
    return str.replace(/\n/g, '<br>')
}
</script>

<template>
  <a-descriptions :column="{ sm: 1 }">
    <a-descriptions-item v-if="taskReport[0]" :label="$t('vul.task.taskType')">
      {{ taskReport[0].task_type }}
    </a-descriptions-item>
    <a-descriptions-item v-if="taskReport[0]" :label="$t('vul.task.lastExecute')">
      {{ dayjs(taskReport[0].latest_execute_time * 1000).format('YYYY-MM-DD HH:mm:ss') }}
    </a-descriptions-item>
  </a-descriptions>
  <p>{{ $t('vul.task.executeResult') }}</p>
  <a-collapse default-active-key="0">
    <a-collapse-panel
      v-for="(resultItem, index) in taskReport"
      :key="index"
      :header="`${t('vul.cves.hosts')}ï¼š ${resultItem.task_result.host_name}`"
    >
      <a-descriptions :column="{ sm: 1 }">
        <a-descriptions-item :label="$t('vul.task.hostIp')">
          {{ resultItem.task_result.host_ip }}
        </a-descriptions-item>
        <a-descriptions-item :label="$t('vul.task.status')">
          {{ RepoSetStatus[resultItem.task_result.status] }}
        </a-descriptions-item>
      </a-descriptions>
      <p>REPO: {{ resultItem.task_result.repo }}</p>
      <span>{{ $t('vul.task.checkItem') }} </span>
      <span v-if="resultItem.task_result.check_items.length === 0">{{ t('common.none') }}</span>
      <a-descriptions>
        <a-descriptions-item
          v-for="item in resultItem.task_result.check_items"
          :key="item.item"
          :label="item.item"
        >
          <CheckCircleTwoTone v-if="item.result" class="icon" two-tone-color="#52c41a" />
          <CloseCircleTwoTone v-else class="icon" two-tone-color="#ff0000" />
        </a-descriptions-item>
      </a-descriptions>
      <h4 style="margin-top: 8px">
        Log:
      </h4>
      <div class="log-container" v-html="logFormat(resultItem.task_result.log)" />
    </a-collapse-panel>
  </a-collapse>
</template>

<style scoped>
.log-container {
  border: 1px solid #eee;
  padding: 10px 5px;
}
</style>
