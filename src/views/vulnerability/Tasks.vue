<script lang="ts" setup>
import dayjs from 'dayjs'
import type { TablePaginationConfig } from 'ant-design-vue'
import { Modal, message } from 'ant-design-vue'
import {
  ExclamationCircleOutlined,
  PlayCircleTwoTone,
  QuestionCircleOutlined,
} from '@ant-design/icons-vue'
import type { SorterResult } from 'ant-design-vue/es/table/interface'
import { computed, h, onBeforeUnmount, onMounted, reactive, ref } from 'vue'
import TaskStatus from './components/TaskStatus.vue'
import { orderMap } from './config'
import PageWrapper from '@/components/PageWrapper.vue'
import type { DistributionParams } from '@/api/paths/types'
import { api } from '@/api'
import type { Direction, Task } from '@/api'
import { hasIntersection } from '@/utils'

const searchKey = ref<string>()

const taskTableColumns = [
  {
    dataIndex: 'task_name',
    title: '任务名称',
    fixed: 'left',
  },
  {
    dataIndex: 'description',
    title: '任务描述',
    width: 200,
  },
  {
    key: 'host_num',
    dataIndex: 'host_num',
    title: '主机数',
    sorter: true,
    width: 90,
    align: 'center',
  },
  {
    dataIndex: 'task_type',
    title: '类型',
    width: 140,
    filters: [
      {
        text: 'cve fix',
        value: 'cve fix',
      },
      {
        text: 'repo set',
        value: 'repo set',
      },
      {
        text: 'cve rollback',
        value: 'cve rollback',
      },
      {
        text: 'hotpatch remove',
        value: 'hotpatch remove',
      },
    ],
  },
  {
    dataIndex: 'cluster_name',
    title: '集群',
    align: 'center',
  },
  {
    dataIndex: 'status',
    title: '状态',
    align: 'center',
    width: 135,
  },
  {
    key: 'create_time',
    dataIndex: 'create_time',
    title: '任务生成时间',
    sorter: true,
  },
  {
    dataIndex: 'operation',
    title: '操作',
    align: 'center',
    width: 120,
    fixed: 'right',
  },
]

const filterMap: Record<string, string[]> = reactive({
  task_type: [],
})

const cutOff = computed(() => (originStr: string) => {
  return originStr.length < 10 ? originStr : `${originStr.substring(0, 10)}...`
})

const taskTableData = ref<Task[]>([])

const tableState = reactive<{
  selectedRowKeys: string[]
  loading: boolean
}>({
  selectedRowKeys: [],
  loading: false,
})

const pagination = reactive({
  total: 0,
  current: 1,
  pageSize: 10,
  showTotal: (total: number) => `总计 ${total} 项`,
  showSizeChanger: true,
})

let timer: NodeJS.Timeout | null
const runningTask = ref<string[]>([])

async function queryTasks(searchKey?: string, sortKey?: string, sortDir?: Direction) {
  /**
   * query task status,if is running re try in 3s
   */
  const queryTasksStatus = async (taskIds: string[]) => {
    const [, res] = await api.getTasksStatus(taskIds)
    if (res && taskTableData.value.length) {
      taskTableData.value.forEach((task) => {
        const status = res.result[task.task_id]
        if (status) {
          task.status = status
          if (task.status.running)
            runningTask.value.push(task.task_id)
        }
      })
      if (runningTask.value.length > 0) {
        timer = setTimeout(() => {
          queryTasksStatus(runningTask.value)
        }, 5000)
      }
      else {
        if (timer) {
          clearTimeout(timer)
          timer = null
        }
      }
    }
  }

  tableState.loading = true
  const [, res] = await api.getTasks({
    page: pagination.current,
    per_page: pagination.pageSize,
    sort: sortKey,
    direction: sortDir,
    filter:
      {
        task_name: searchKey,
        task_type: filterMap.task_type,
      } || {},
  })
  if (res) {
    taskTableData.value = res.result
    pagination.total = res.total_count
    const taskIds = taskTableData.value.map(task => task.task_id)
    if (taskIds.length > 0)
      await queryTasksStatus(taskIds)
  }
  tableState.loading = false
}

function handleTableChange(page: TablePaginationConfig, filters: Record<string, string[] | null>, sorter: SorterResult<Task>) {
  page.current && (pagination.current = page.current)
  page.pageSize && (pagination.pageSize = page.pageSize)
  if (sorter.column) {
    const sortKey = sorter.columnKey
    const sortDir = sorter.order
    queryTasks(searchKey.value, sortKey as string, orderMap[sortDir as Direction])
    return
  }
  filterMap.task_type = filters.task_type ?? []
  queryTasks(searchKey.value)
}

function onSelectChange(selectedRowKeys: string[]) {
  tableState.selectedRowKeys = selectedRowKeys
}

/**
 * delete tasks with task id
 * distrubition
 */
async function deleteTask(taskId: string[] | string) {
  let taskIds = taskId
  const params: DistributionParams<{ task_list: string[] }> = {}
  if (typeof taskId === 'string')
    taskIds = [taskId]
  if (hasIntersection(taskIds as string[], runningTask.value)) {
    message.warning('当前选中有正在执行的任务，请稍后重试！')
    return
  }
  const taskList = taskTableData.value.filter(task => taskIds.includes(task.task_id))
  taskList.forEach(({ task_id, cluster_id }) => {
    if (!params[cluster_id])
      params[cluster_id] = { task_list: [task_id] }
    else
      params[cluster_id].task_list.push(task_id)
  })
  const [,res] = await api.deleteTasks(params)
  if (res) {
    const someFailed = Object.values(res).some(value => value.label !== 'Succeed')
    if (!someFailed)
      message.success('删除成功')

    else message.warning('下发成功,部分删除成功')
    await queryTasks()
  }
}

const isDeleting = ref(false)

/**
 * delete tasks with task id
 * distrubition
 */
async function deleteTaskBatch() {
  if (tableState.selectedRowKeys.length === 0) {
    message.info('请选择至少一个任务进行删除！')
    return
  }
  const taskList = taskTableData.value.filter(({ task_id }) =>
    tableState.selectedRowKeys.includes(task_id),
  )

  Modal.confirm({
    title: `确定删除以下任务?`,
    icon: h(ExclamationCircleOutlined),
    content: `${taskList.map(({ task_name }) => task_name).join(',')}`,
    okType: 'danger',
    okText: '确定',
    onOk: async () => {
      try {
        isDeleting.value = true
        await deleteTask(tableState.selectedRowKeys)
        tableState.selectedRowKeys = []
      }
      catch (error) {
      }
      finally {
        isDeleting.value = false
      }
    },
  })
}
/**
 * excute task with task id
 * @param task
 */
async function handleExcuteTask(task: Task) {
  const { cluster_id, task_id } = task
  const params: DistributionParams<{ task_id: string }> = {}
  params[cluster_id] = { task_id }
  const [_] = await api.executeTask(params)
  if (!_) {
    message.success('执行成功')
    queryTasks()
  }
}

function handleSearch(key: string) {
  const taskName = key || undefined

  queryTasks(taskName)
}

onMounted(() => {
  queryTasks()
})

onBeforeUnmount(() => {
  if (timer) {
    clearTimeout(timer)
    timer = null
  }
})
</script>

<template>
  <PageWrapper>
    <a-card>
      <a-row type="flex" justify="space-between">
        <a-col>
          <a-input-search v-model="searchKey" placeholder="按任务名搜索" :max-length="40" @search="handleSearch" />
        </a-col>
        <a-col>
          <a-row type="flex" :gutter="6">
            <a-col v-if="tableState.selectedRowKeys.length > 0">
              <a-alert type="info" show-icon class="delete-alert">
                <template #message>
                  <span>{{ `已选择${tableState.selectedRowKeys.length}项` }}</span>
                  <a @click="tableState.selectedRowKeys = []"> 清除选择</a>
                </template>
              </a-alert>
            </a-col>
          </a-row>
        </a-col>
        <a-col>
          <a-button type="primary" :loading="isDeleting" @click="deleteTaskBatch">
            批量删除
          </a-button>
        </a-col>
      </a-row>
      <a-table
        row-key="task_id"
        :columns="taskTableColumns"
        :data-source="taskTableData"
        :loading="tableState.loading"
        :pagination="pagination"
        :scroll="{ x: 1260 }"
        :row-selection="{
          selectedRowKeys: tableState.selectedRowKeys,
          onChange: onSelectChange,
        }"
        @change="handleTableChange"
      >
        <template #bodyCell="{ record, column }">
          <template v-if="column.dataIndex === 'task_name'">
            <router-link
              :to="{
                path: `/vulnerability/tasks/task-detail`,
                query: { taskId: record.task_id, taskType: record.task_type },
              }"
            >
              {{ record.task_name }}
            </router-link>
          </template>
          <template v-if="column.dataIndex === 'description'">
            <a-tooltip placement="top">
              <template #title>
                <span>{{ record.description }}</span>
              </template>
              {{ cutOff(record.description) }}
            </a-tooltip>
          </template>
          <template v-if="column.dataIndex === 'status'">
            <TaskStatus :status="record.status" />
          </template>
          <template v-if="column.dataIndex === 'create_time'">
            {{ dayjs(record.create_time * 1000).format('YYYY-MM-DD HH:mm:ss') }}
          </template>
          <template v-if="column.dataIndex === 'operation'">
            <a-popconfirm @confirm="handleExcuteTask(record)">
              <template #icon>
                <PlayCircleTwoTone />
              </template>
              <template #title>
                <p style="white-space: nowrap">
                  你确定删除这个任务吗?
                </p>
              </template>
              <a>执行</a>
            </a-popconfirm>
            <a-divider type="vertical" />
            <a-popconfirm @confirm="deleteTask(record.task_id)">
              <template #icon>
                <QuestionCircleOutlined style="color: red" />
              </template>
              <template #title>
                <p style="white-space: nowrap">
                  你确定删除这个任务吗?
                </p>
              </template>
              <a>删除</a>
            </a-popconfirm>
          </template>
        </template>
      </a-table>
    </a-card>
  </PageWrapper>
</template>
